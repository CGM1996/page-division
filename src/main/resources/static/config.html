<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<style type="text/css">
    .table-preview {
        margin: 0 auto;
        width: 192px;
        height: 108px;
        border: #2e6da4 solid;
        text-align: center;
        table-layout: fixed;
    }
    .edit-button {
        float: right;
        margin-top: 4px;
        margin-right: 10px;
        color: royalblue;
        cursor: pointer;
    }
</style>
<html lang="zh-cn">
<head>
    <title>配置中心</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="icon" href="./img/icon.png" >
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/popper.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
    const domain = "http://127.0.0.1:8090";
    // 配置名称列表
    let configList;
    // 是否新建
    let isNew = true;

    // onload事件
    $(function(){
        $.ajaxSettings.async = false;
        $.get(domain + "/config/query/list", function(data){
            console.log(data);
            configList = data;
            for (let i = 0; i < configList.length; i++) {
                console.log(configList[i]);
                let seq = i + 1;
                $("#ulMenu").append("<li><a href='#' id='li" + seq +"' onclick='edit(" + seq +")'>"
                    + configList[i] + "</a></li>");
            }
        });
    });

    // 新建配置
    function add() {
        isNew = true;

        $("li.active").attr("class", "");
        $("#liAdd").attr("class", "active");
        $("#configName").removeAttr("readonly");
        $("input").val("");
    }

    // 修改已有配置
    function edit(i) {
        isNew = false;

        $("li.active").attr("class", "");
        $("#li" + i).attr("class", "active");
        $("#configName").attr("readonly","readonly");
        $("input").val("");

        // 获取配置详情并填充表单
        $.get(domain + "/config/query?configName=" + configList[i - 1], function(config){
            console.log(config);
            $("#configName").val(config.configName);
            $("#divXY").val(config.divX + "*" + config.divY);
            let list = config.list;
            for (let i = 0; i < list.length; i ++) {
                let seq = i + 1;
                $("#cell" + seq).val(list[i].upperLeft + "," + list[i].lowerRight);
                $("#src" + seq).val(list[i].src);
            }
        });
    }

    // 绘制预览图，布局输入后事件
    function drawTable() {
        console.log("drawing table...");
        let divXY = $("#divXY").val();
        let divX;
        let divY;
        if (divXY.indexOf("*") > -1) {
            divX = parseInt(divXY.split("*")[0]);
            divY = parseInt(divXY.split("*")[1]);
        } else if (divXY.indexOf("×") > -1) {
            divX = parseInt(divXY.split("×")[0]);
            divY = parseInt(divXY.split("×")[1]);
        }
        let previewTable = $("#previewTable");
        previewTable.empty();
        let count = 0;
        for (let i = 0; i < divY; i ++) {
            previewTable.append("<tr id=\"tr" + i + "\">");
            for (let j = 0; j < divX; j++) {
                count ++;
                $("#tr" + i).append("<td>" + count + "</td>")
            }
            previewTable.append("</tr>");
        }
    }

    // 保存
    function save() {
        let config = {};
        config.configName = $("#configName").val();
        let divXY = $("#divXY").val();
        if (divXY.indexOf("*") > -1) {
            config.divX = divXY.split("*")[0];
            config.divY = divXY.split("*")[1];
        } else if (divXY.indexOf("×") > -1) {
            config.divX = divXY.split("×")[0];
            config.divY = divXY.split("×")[1];
        }
        config.list = [];
        for (let i = 1; i < 5; i ++) {
            let cellConfig = {};
            cellConfig.index = i;
            cellConfig.src = $("#src" + i).val();
            let scope = $("#cell" + i).val();

            cellConfig.upperLeft = scope;
            cellConfig.lowerRight = scope;
            if (scope.indexOf(",") > 0) {
                cellConfig.upperLeft = scope.split(",")[0];
                cellConfig.lowerRight = scope.split(",")[1];
            }

            config.list.push(cellConfig);
        }

        let url = domain + "/config/add";
        if (!isNew) {
            url = domain + "/config/update"
        }
        $.ajax({
            url:url,
            type:"POST",
            data:JSON.stringify(config),
            contentType:"application/json; charset=utf-8",
            async:false,
            success: function(result){
                console.log(result);
                if (result === "SUCCESS") {
                    configList.push(config.configName);
                    $("#ulMenu").append("<li><a href='#' id='li" + configList.length +"'" +
                        " onclick='edit(" + configList.length +")'>" + config.configName +
                        "</a></li>");
                }
            }
        });
    }

</script>
<div class="container">
    <div class="row clearfix">
        <div class="col-md-12 column">
            <nav class="navbar navbar-default" role="navigation">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">配置中心</a>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="#">Link</a>
                        </li>
                        <li>
                            <a href="#">Link</a>
                        </li>
                    </ul>
                </div>

            </nav>
        </div>
        <div class="col-md-3 column">
            <ul class="nav nav-pills nav-stacked" id="ulMenu">
                <li class="active" id="liAdd" onclick="add()"><a href="#">新建</a></li>
            </ul>
        </div>
        <div class="col-md-9 column">
            <form class="form-horizontal" id="configForm" role="form">
                <h4>基本设置</h4>
                <div class="col-md-6 column" style="height: 124px">
                    <div class="form-group">
                        <label for="configName" class="col-sm-4 control-label">配置名称</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="configName"
                                   placeholder="请输入名称">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="divXY" class="col-sm-4 control-label">基本布局</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="divXY" onchange="drawTable()"
                                   placeholder="最大 4*2 或 3*3">
                        </div>
                    </div>
                </div>
                <div class="col-md-6 column" style="height: 124px">
                    <table id="previewTable" border="1" class="table-preview"></table>
                </div>
                <h4>单元格配置</h4>
                <div class="form-group">
                    <label for="cell1" class="col-sm-2 control-label">单元格1</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="cell1"
                               placeholder="请输入范围">
                    </div>
                    <label for="src1" class="col-sm-2 control-label">地址</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="src1"
                               placeholder="请输入地址">
                    </div>
                </div>
                <div class="form-group">
                    <label for="cell2" class="col-sm-2 control-label">单元格2</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="cell2"
                               placeholder="请输入范围">
                    </div>
                    <label for="src2" class="col-sm-2 control-label">地址</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="src2"
                               placeholder="请输入地址">
                    </div>
                </div><div class="form-group">
                <label for="cell3" class="col-sm-2 control-label">单元格3</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="cell3"
                           placeholder="请输入范围">
                </div>
                <label for="src3" class="col-sm-2 control-label">地址</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="src3"
                           placeholder="请输入地址">
                </div>
            </div><div class="form-group">
                <label for="cell4" class="col-sm-2 control-label">单元格4</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="cell4"
                           placeholder="请输入范围">
                </div>
                <label for="src4" class="col-sm-2 control-label">地址</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="src4"
                           placeholder="请输入地址">
                </div>
            </div>
            </form>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button onclick="save()" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>